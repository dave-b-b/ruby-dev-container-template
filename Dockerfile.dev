# Development Dockerfile for Rails
# This container provides an isolated development environment where:
# - All development happens INSIDE the container
# - Code changes sync bidirectionally with the host via volume mount
# - Ruby gems are containerized and persist via named volume
# - No Ruby/Rails installation needed on the host machine

FROM ruby:3.3-slim

# Install system dependencies
RUN apt-get update -qq && \
    apt-get install -y \
    build-essential \
    git \
    curl \
    libpq-dev \
    libsqlite3-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libyaml-dev \
    libvips \
    vim \
    sudo \
    pkg-config \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js (required for Claude CLI)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code
RUN claude config set auto-update false

# Install Bundler
RUN gem install bundler

# Create non-root user
RUN groupadd --gid 1000 developer && \
    useradd --uid 1000 --gid developer --shell /bin/bash --create-home developer && \
    echo "developer ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Set up work directory and ensure developer owns it
WORKDIR /rails
RUN chown developer:developer /rails

# Configure bundler to install gems to vendor/bundle inside the project
# This avoids permission issues since /rails is owned by developer
ENV BUNDLE_PATH=/rails/vendor/bundle \
    BUNDLE_BIN=/rails/vendor/bundle/bin
ENV PATH="${BUNDLE_BIN}:${PATH}"

# Copy Gemfile and Gemfile.lock for initial bundle install
# These files will be overridden by the volume mount at runtime
COPY --chown=developer:developer Gemfile Gemfile.lock ./

# Copy the development entrypoint script
COPY --chown=developer:developer bin/docker-entrypoint-dev.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint-dev.sh

# Switch to developer user for all operations
USER developer

# Install initial gems (will be stored in vendor/bundle when container runs)
RUN bundle install

# Default command - starts an interactive bash shell
# Developers can work inside the container using:
# - docker compose run web bash (new container)
# - docker compose exec web bash (existing container)
CMD ["/bin/bash"]
